name: Docker Registry CI/CD Test

on:
  push:
    branches: [ main, develop, 'feature/*' ]
  pull_request:
    branches: [ main, develop ]

env:
  # ë¡œì»¬ Registry (ë‚˜ì¤‘ì— ì‹¤ì œ ì„œë²„ IPë¡œ ë³€ê²½)
  REGISTRY_URL: localhost:15432
  IMAGE_NAME: testjson

jobs:
  build-and-deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        clean: true
        fetch-depth: 0
        
    - name: Determine environment from branch
      id: env
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "port=15401" >> $GITHUB_OUTPUT
        elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
          echo "environment=staging" >> $GITHUB_OUTPUT  
          echo "port=15402" >> $GITHUB_OUTPUT
        else
          echo "environment=development" >> $GITHUB_OUTPUT
          echo "port=15403" >> $GITHUB_OUTPUT
        fi
        
    - name: Set image tag
      id: tag
      run: |
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        BRANCH_NAME=${BRANCH_NAME//\//-}  # Replace / with -
        SHORT_SHA=${GITHUB_SHA:0:7}
        IMAGE_TAG="${{ steps.env.outputs.environment }}-${BRANCH_NAME}-${SHORT_SHA}"
        echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Image tag: ${IMAGE_TAG}"
        
    - name: Check Registry connectivity
      run: |
        echo "ğŸ” Registry ì—°ê²° í…ŒìŠ¤íŠ¸..."
        curl -f http://${{ env.REGISTRY_URL }}/v2/ || (echo "âŒ Registry ì ‘ê·¼ ì‹¤íŒ¨" && exit 1)
        echo "âœ… Registry ì ‘ê·¼ ì„±ê³µ"
        
    - name: Build Docker image
      run: |
        echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        echo "Registry: ${{ env.REGISTRY_URL }}"
        echo "Image: ${{ env.IMAGE_NAME }}"
        echo "Tag: ${{ steps.tag.outputs.tag }}"
        
        docker build -t ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }} . || {
          echo "âŒ Docker ë¹Œë“œ ì‹¤íŒ¨"
          echo "=== Docker ë¡œê·¸ ==="
          docker system df
          docker images
          exit 1
        }
        
        echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
        
    - name: Push to Registry
      run: |
        echo "ğŸ“¤ Registryì— ì´ë¯¸ì§€ í‘¸ì‹œ ì¤‘..."
        docker push ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }} || {
          echo "âŒ Registry í‘¸ì‹œ ì‹¤íŒ¨"
          echo "=== Registry ìƒíƒœ í™•ì¸ ==="
          curl -s http://${{ env.REGISTRY_URL }}/v2/_catalog || echo "Registry ì¹´íƒˆë¡œê·¸ ì¡°íšŒ ì‹¤íŒ¨"
          exit 1
        }
        echo "âœ… Registry í‘¸ì‹œ ì™„ë£Œ"
        
    - name: Deploy locally (Test)
      run: |
        echo "ğŸš€ ë¡œì»¬ í…ŒìŠ¤íŠ¸ ë°°í¬ ì¤‘..."
        
        # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
        docker stop testjson-${{ steps.env.outputs.environment }} 2>/dev/null || true
        docker rm testjson-${{ steps.env.outputs.environment }} 2>/dev/null || true
        
        # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        docker run -d \
          --name testjson-${{ steps.env.outputs.environment }} \
          -p ${{ steps.env.outputs.port }}:5000 \
          -e ENVIRONMENT=${{ steps.env.outputs.environment }} \
          -e BRANCH=${GITHUB_REF#refs/heads/} \
          -e COMMIT_SHA=${{ github.sha }} \
          ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}
          
        echo "â³ ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°..."
        sleep 10
        
    - name: Health Check
      run: |
        echo "ğŸ¥ Health Check ìˆ˜í–‰ ì¤‘..."
        
        # Health endpoint í™•ì¸
        HEALTH_URL="http://localhost:${{ steps.env.outputs.port }}/health"
        echo "Health Check URL: ${HEALTH_URL}"
        
        for i in {1..5}; do
          if curl -f ${HEALTH_URL}; then
            echo "âœ… Health Check ì„±ê³µ!"
            break
          else
            echo "âŒ Health Check ì‹¤íŒ¨ (ì‹œë„ $i/5)"
            if [ $i -eq 5 ]; then
              echo "=== ì»¨í…Œì´ë„ˆ ë¡œê·¸ ==="
              docker logs testjson-${{ steps.env.outputs.environment }}
              exit 1
            fi
            sleep 5
          fi
        done
        
        # ì•± ì •ë³´ í™•ì¸
        echo "ğŸ“‹ ë°°í¬ëœ ì•± ì •ë³´:"
        curl -s http://localhost:${{ steps.env.outputs.port }}/ || echo "ì•± ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨"
        
    - name: Deployment Summary
      if: always()
      run: |
        echo "ğŸ¯ ë°°í¬ ì™„ë£Œ!"
        echo "Environment: ${{ steps.env.outputs.environment }}"
        echo "Image: ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}"
        echo "Port: ${{ steps.env.outputs.port }}"
        echo "URL: http://localhost:${{ steps.env.outputs.port }}"
        
        echo "=== Registry ìƒíƒœ ==="
        curl -s http://${{ env.REGISTRY_URL }}/v2/_catalog | jq . || echo "Registry ì¡°íšŒ ì‹¤íŒ¨" 