name: Local Registry Test

on:
  push:
    branches: [ main, develop, 'feature/*' ]
  pull_request:
    branches: [ main, develop ]

env:
  # ë¡œì»¬ Registry (ë‚˜ì¤‘ì— ì‹¤ì œ ì„œë²„ IPë¡œ ë³€ê²½)
  REGISTRY_URL: localhost:15432
  IMAGE_NAME: testjson

jobs:
  # í™˜ê²½ ê²°ì •
  setup:
    runs-on: self-hosted
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      image-tag: ${{ steps.env.outputs.image-tag }}
    
    steps:
    - name: Determine environment
      id: env
      run: |
        # ë¸Œëœì¹˜ë³„ í™˜ê²½ ê²°ì •
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "environment=production" >> $GITHUB_OUTPUT
        elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
          echo "environment=staging" >> $GITHUB_OUTPUT
        else
          echo "environment=development" >> $GITHUB_OUTPUT
        fi
        
        # ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
        BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9.-]/-/g')
        COMMIT_SHORT=$(echo "${{ github.sha }}" | cut -c1-8)
        IMAGE_TAG="${{ steps.env.outputs.environment }}-${BRANCH_NAME}-${COMMIT_SHORT}"
        echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
        
        echo "ğŸ¯ Environment: ${{ steps.env.outputs.environment }}"
        echo "ğŸ·ï¸  Image Tag: $IMAGE_TAG"

  # ë¹Œë“œ ë° Registry í‘¸ì‹œ
  build:
    needs: setup
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check Registry connectivity
      run: |
        echo "ğŸ” Registry ì—°ê²° í™•ì¸: ${{ env.REGISTRY_URL }}"
        if curl -f http://${{ env.REGISTRY_URL }}/v2/ 2>/dev/null; then
          echo "âœ… Registry ì—°ê²° ì„±ê³µ"
        else
          echo "âŒ Registry ì—°ê²° ì‹¤íŒ¨ - Registryê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”"
          echo "ğŸ’¡ Registry ì‹œì‘: cd docker-registry && ./start-registry.sh"
          exit 1
        fi

    - name: Build Docker image
      run: |
        echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        docker build \
          --build-arg IMAGE_TAG=${{ needs.setup.outputs.image-tag }} \
          --build-arg ENVIRONMENT=${{ needs.setup.outputs.environment }} \
          --build-arg COMMIT_SHA=${{ github.sha }} \
          --build-arg BRANCH_NAME=${{ github.ref_name }} \
          -t ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.image-tag }} \
          -t ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest \
          .
        
        echo "âœ… ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
        docker images | grep ${{ env.IMAGE_NAME }}

    - name: Push to Registry
      run: |
        echo "ğŸ“¦ Registryì— ì´ë¯¸ì§€ í‘¸ì‹œ ì¤‘..."
        
        # íƒœê·¸ë³„ í‘¸ì‹œ
        docker push ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.image-tag }}
        docker push ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest
        
        echo "âœ… í‘¸ì‹œ ì™„ë£Œ!"
        echo "ğŸ“¦ Image: ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.image-tag }}"

    - name: Verify image in Registry
      run: |
        echo "ğŸ” Registryì—ì„œ ì´ë¯¸ì§€ í™•ì¸ ì¤‘..."
        
        # Registry APIë¡œ ì´ë¯¸ì§€ í™•ì¸
        if curl -f http://${{ env.REGISTRY_URL }}/v2/${{ env.IMAGE_NAME }}/tags/list 2>/dev/null; then
          echo "âœ… ì´ë¯¸ì§€ê°€ Registryì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë¨"
          curl -s http://${{ env.REGISTRY_URL }}/v2/${{ env.IMAGE_NAME }}/tags/list | jq .
        else
          echo "âŒ Registryì—ì„œ ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
          exit 1
        fi

  # ë¡œì»¬ í…ŒìŠ¤íŠ¸ ë°°í¬ (ì‹¤ì œ ì„œë²„ ë°°í¬ ì „ í…ŒìŠ¤íŠ¸)
  test-deploy:
    needs: [setup, build]
    runs-on: self-hosted
    if: success()
    
    steps:
    - name: Test local deployment
      run: |
        echo "ğŸš€ ë¡œì»¬ í…ŒìŠ¤íŠ¸ ë°°í¬ ì‹œì‘..."
        
        # ê¸°ì¡´ í…ŒìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ì •ë¦¬
        CONTAINER_NAME="testjson-local-test"
        if docker ps -a --format "table {{.Names}}" | grep -q "^$CONTAINER_NAME$"; then
          echo "ğŸ›‘ ê¸°ì¡´ í…ŒìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ì •ë¦¬"
          docker stop $CONTAINER_NAME || true
          docker rm $CONTAINER_NAME || true
        fi
        
        # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        echo "ğŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
        docker run -d \
          --name $CONTAINER_NAME \
          -p 8081:8080 \
          -e IMAGE_TAG=${{ needs.setup.outputs.image-tag }} \
          -e ENVIRONMENT=${{ needs.setup.outputs.environment }} \
          -e BRANCH_NAME=${{ github.ref_name }} \
          -e COMMIT_SHA=${{ github.sha }} \
          ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.image-tag }}
        
        echo "â³ ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°..."
        sleep 10

    - name: Health check
      run: |
        echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰ ì¤‘..."
        
        # ìµœëŒ€ 1ë¶„ ë™ì•ˆ í—¬ìŠ¤ì²´í¬
        for i in {1..6}; do
          if curl -f http://localhost:8081/ > /dev/null 2>&1; then
            echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
            echo "ğŸŒ ì•± URL: http://localhost:8081"
            
            # ì•± ì‘ë‹µ í™•ì¸
            echo "ğŸ“± ì•± ì‘ë‹µ:"
            curl -s http://localhost:8081/ | head -5
            break
          fi
          echo "â³ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘... ($i/6)"
          sleep 10
        done

  # ê²°ê³¼ ì•Œë¦¼
  notify:
    needs: [setup, build, test-deploy]
    runs-on: self-hosted
    if: always()
    
    steps:
    - name: Deployment summary
      run: |
        echo "ğŸ“Š ==================================="
        echo "ğŸ“Š CI/CD í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½"
        echo "ğŸ“Š ==================================="
        echo "ğŸ¯ Environment: ${{ needs.setup.outputs.environment }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ·ï¸  Image Tag: ${{ needs.setup.outputs.image-tag }}"
        echo "ğŸ“¦ Registry: ${{ env.REGISTRY_URL }}"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        
        if [[ "${{ needs.test-deploy.result }}" == "success" ]]; then
          echo "âœ… ìƒíƒœ: ì„±ê³µ"
          echo "ğŸŒ í…ŒìŠ¤íŠ¸ URL: http://localhost:8081"
        else
          echo "âŒ ìƒíƒœ: ì‹¤íŒ¨"
        fi
        
        echo "ğŸ“Š ==================================="
        
        # Registry UI ë§í¬
        echo "ğŸ–¥ï¸  Registry UI: http://localhost:8090"
        echo "ğŸ’¡ Registry ê´€ë¦¬: cd docker-registry && docker-compose logs" 